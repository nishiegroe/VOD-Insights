<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Settings - Apex Event Tracker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
  <div class="app">
    <header class="header">
      <div>
        <h1>Settings</h1>
        <p>Manage capture, bookmarks, and auto-split in one place.</p>
      </div>
      <div class="status">
        <div class="header-actions">
          <a class="link-button" href="/legacy">Home</a>
          <a class="link-button" href="/legacy/settings">Settings</a>
          <a class="link-button" href="/legacy/clips">Preview Clips</a>
          <a class="link-button" href="/legacy/vods">VOD Library</a>
          <span class="badge {{ 'on' if status.bookmark_running else 'off' }}">
            {{ 'Recording Active' if status.bookmark_running else 'Idle' }}
          </span>
        </div>
      </div>
    </header>

    <section class="card controls centered">
      <h2>Bookmarks Session</h2>
      <div class="button-row">
        <form method="post" action="/control/start">
          <button type="submit" class="primary">Start Session</button>
        </form>
        <form method="post" action="/control/stop">
          <button type="submit" class="danger">End Session</button>
        </form>
      </div>
      <p class="hint">Start/Stop controls run bookmarks mode for live sessions.</p>
    </section>

    <section class="grid">
      <form class="card" method="post" action="/config">
        <h2>Capture + Detection</h2>

        <div class="section-block">
          <div class="section-title">Capture Area</div>
          <div class="input-row">
            <a class="link-button" href="/legacy/capture-area">Open Capture Area Tool</a>
          </div>
          <div class="section-grid">
            <label>Left <input name="capture_left" type="number" value="{{ config.capture.left }}" /></label>
            <label>Top <input name="capture_top" type="number" value="{{ config.capture.top }}" /></label>
            <label>Width <input name="capture_width" type="number" value="{{ config.capture.width }}" /></label>
            <label>Height <input name="capture_height" type="number" value="{{ config.capture.height }}" /></label>
          </div>
        </div>

        <div class="section-block">
          <div class="section-title">Performance</div>
          <div class="section-grid">
            <label>FPS <input name="capture_fps" type="number" value="{{ config.capture.fps }}" /></label>
            <label>Scale <input name="capture_scale" type="number" step="0.1" value="{{ config.capture.scale }}" /></label>
            <label>Threshold <input name="capture_threshold" type="number" value="{{ config.capture.threshold }}" /></label>
            <label>Backend
              <select name="capture_backend">
                <option value="mss" {% if config.capture.backend == 'mss' %}selected{% endif %}>mss</option>
                <option value="dxcam" {% if config.capture.backend == 'dxcam' %}selected{% endif %}>dxcam</option>
                <option value="auto" {% if config.capture.backend == 'auto' %}selected{% endif %}>auto</option>
              </select>
            </label>
          </div>
        </div>

        <div class="section-block">
          <div class="section-title">OCR + Detection</div>
          <label>OCR Interval (s) <input name="ocr_interval" type="number" step="0.1" value="{{ config.ocr.interval_seconds }}" /></label>
          <label>Keywords (comma-separated)
            <textarea name="detection_keywords">{{ config.detection.keywords | join(', ') }}</textarea>
          </label>
          <label>Cooldown (s) <input name="detection_cooldown" type="number" step="0.1" value="{{ config.detection.cooldown_seconds }}" /></label>
        </div>

        <button type="submit" class="primary">Save Config</button>
      </form>

      <form class="card" method="post" action="/config">
        <h2>Output + Splits</h2>

        <div class="section-block">
          <div class="section-title">Recordings Directory</div>
          <label>Recordings Directory</label>
          <div class="input-row">
            <input name="replay_dir" type="text" value="{{ config.replay.directory }}" />
            <button type="submit" formaction="/choose-replay-dir" class="secondary">Browse</button>
          </div>
        </div>

        <div class="section-block">
          <div class="section-title">Bookmarks</div>
          <label>Bookmarks Directory <input name="bookmarks_directory" type="text" value="{{ config.bookmarks.directory }}" /></label>
          <label>Session Prefix <input name="bookmarks_prefix" type="text" value="{{ config.bookmarks.session_prefix }}" /></label>
          <label>Format
            <select name="bookmarks_format">
              <option value="csv" {% if config.bookmarks.format == 'csv' %}selected{% endif %}>csv</option>
              <option value="jsonl" {% if config.bookmarks.format == 'jsonl' %}selected{% endif %}>jsonl</option>
            </select>
          </label>
        </div>

        <div class="section-block">
          <div class="section-title">Auto-Split</div>
          <label>Recordings Dir <input name="split_recordings_dir" type="text" value="{{ config.split.recordings_dir }}" /></label>
          <label>Output Dir <input name="split_output_dir" type="text" value="{{ config.split.output_dir }}" /></label>
          <label class="slider-label">
            <div class="slider-title">Pre Seconds <span id="preValue">{{ config.split.pre_seconds }}</span>s</div>
            <input name="split_pre" type="range" min="0" max="120" step="1" value="{{ config.split.pre_seconds }}" data-output="preValue" />
          </label>
          <label class="slider-label">
            <div class="slider-title">Post Seconds <span id="postValue">{{ config.split.post_seconds }}</span>s</div>
            <input name="split_post" type="range" min="0" max="120" step="1" value="{{ config.split.post_seconds }}" data-output="postValue" />
          </label>
          <label>Merge Gap Seconds <input name="split_gap" type="number" step="0.5" value="{{ config.split.merge_gap_seconds }}" /></label>
        </div>

        <button type="submit" class="primary">Save Config</button>
      </form>
    </section>

    <section class="card">
      <h2>Recent Clips</h2>
      {% if clips %}
        <ul class="clip-list">
        {% for clip in clips %}
          <li>
            <div class="clip-name">{{ clip.name }}</div>
            <div class="clip-meta">{{ clip.path }}</div>
          </li>
        {% endfor %}
        </ul>
      {% else %}
        <p class="hint">No clips found.</p>
      {% endif %}
    </section>

    <section class="card">
      <h2>Logs</h2>
      <pre class="logs">{% for line in log_lines %}{{ line }}
{% endfor %}</pre>
    </section>
  </div>
  <script>
    const sliders = document.querySelectorAll('input[type="range"][data-output]');
    sliders.forEach((slider) => {
      const output = document.getElementById(slider.dataset.output);
      if (!output) {
        return;
      }
      const update = () => {
        output.textContent = slider.value;
      };
      slider.addEventListener('input', update);
      update();
    });
  </script>
</body>
</html>
