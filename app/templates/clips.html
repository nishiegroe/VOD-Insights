<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clip Preview - Apex Event Tracker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
  <div class="app">
    <header class="header">
      <div>
        <h1>Clip Preview</h1>
        <p>Review your latest clips and verify the split output.</p>
      </div>
      <div class="status">
        <div class="header-actions">
          <a class="link-button" href="/legacy">Home</a>
          <a class="link-button" href="/legacy/settings">Settings</a>
          <a class="link-button" href="/legacy/clips">Preview Clips</a>
          <a class="link-button" href="/legacy/vods">VOD Library</a>
          <span class="badge {{ 'on' if status.bookmark_running else 'off' }}">
            {{ 'Recording Active' if status.bookmark_running else 'Idle' }}
          </span>
        </div>
      </div>
    </header>

    <section class="card clip-viewer">
      <h2>Clips</h2>
      <div class="clip-meta">Output folder: {{ clips_dir }}</div>
      {% if clips %}
        <div class="clip-layout">
          <div class="clip-preview">
            <div class="clip-preview-heading">
              <div class="clip-preview-title" id="previewTitle">{{ clips[0].details.pretty_time }}</div>
              {% if clips[0].details.above_avg %}
                <span class="chip highlight" id="previewTop" title="{{ clips[0].details.top_reason }}">Top</span>
              {% else %}
                <span class="chip highlight hidden" id="previewTop"></span>
              {% endif %}
            </div>
            <div class="clip-preview-subtitle" id="previewOffset">{{ clips[0].details.session_offset }}</div>
            <div class="clip-badges" id="previewBadges">
              {% if clips[0].details.counts %}
                <span class="chip">Kills: {{ clips[0].details.counts.kills }}</span>
                <span class="chip">Assists: {{ clips[0].details.counts.assists }}</span>
                <span class="chip">Deaths: {{ clips[0].details.counts.deaths }}</span>
              {% endif %}
            </div>
            <video id="previewPlayer" controls preload="metadata" src="/media-path?path={{ clips[0].path | urlencode }}"></video>
          </div>
          <div class="clip-rail">
            {% for group in clip_groups %}
              {% set is_first_group = loop.first %}
              <div class="clip-group">
                <div class="clip-group-title">{{ group.label }}</div>
                <div class="clip-group-grid">
                  {% for clip in group.clips %}
                    <div
                      class="clip-tile{% if loop.first and is_first_group %} active{% endif %}"
                      role="button"
                      tabindex="0"
                      data-file="{{ clip.name }}"
                      data-src="/media-path?path={{ clip.path | urlencode }}"
                      data-name="{{ clip.name }}"
                      data-path="{{ clip.path }}"
                      data-timestamp="{{ clip.details.pretty_time }}"
                      data-offset="{{ clip.details.session_offset }}"
                      data-kills="{% if clip.details.counts %}{{ clip.details.counts.kills }}{% endif %}"
                      data-assists="{% if clip.details.counts %}{{ clip.details.counts.assists }}{% endif %}"
                      data-deaths="{% if clip.details.counts %}{{ clip.details.counts.deaths }}{% endif %}"
                      data-top="{% if clip.details.above_avg %}1{% else %}0{% endif %}"
                      data-top-reason="{% if clip.details.top_reason %}{{ clip.details.top_reason }}{% endif %}"
                    >
                      <div class="clip-thumb">
                        <video muted playsinline preload="metadata" src="/media-path?path={{ clip.path | urlencode }}"></video>
                      </div>
                      <div class="clip-row clip-title-row">
                        <div class="clip-meta clip-time">
                          {{ clip.details.pretty_time }}
                        </div>
                        {% if clip.details.above_avg %}
                          <span class="chip highlight" title="{{ clip.details.top_reason }}">Top</span>
                        {% endif %}
                      </div>
                      <div class="clip-meta clip-offset">
                        {{ clip.details.session_offset }}
                      </div>
                      <div class="clip-row">
                        <div class="clip-badges">
                          {% if clip.details.counts %}
                            <span class="chip">Kills: {{ clip.details.counts.kills }}</span>
                            <span class="chip">Assists: {{ clip.details.counts.assists }}</span>
                            <span class="chip">Deaths: {{ clip.details.counts.deaths }}</span>
                          {% else %}
                            <span class="chip">Counts unavailable</span>
                          {% endif %}
                        </div>
                        <div class="clip-actions">
                          <button type="button" class="icon-button" data-open-url="/open-folder-path?path={{ clip.path | urlencode }}" title="Open in folder">üìÅ</button>
                          <a class="icon-link" href="/download-path?path={{ clip.path | urlencode }}" title="Download">‚¨áÔ∏è</a>
                          <button type="button" class="icon-button danger" data-delete-url="/delete-path?path={{ clip.path | urlencode }}" title="Delete">üóëÔ∏è</button>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <p class="hint">No clips found in the output folder.</p>
      {% endif %}
    </section>
  </div>
  <script>
    const previewPlayer = document.getElementById('previewPlayer');
    const previewTitle = document.getElementById('previewTitle');
    const previewOffset = document.getElementById('previewOffset');
    const previewBadges = document.getElementById('previewBadges');
    const previewTop = document.getElementById('previewTop');
    const clipTiles = document.querySelectorAll('.clip-tile');
    const openButtons = document.querySelectorAll('.icon-button[data-open-url]');
    const deleteButtons = document.querySelectorAll('.icon-button[data-delete-url]');
    const iconLinks = document.querySelectorAll('.icon-link');

    const selectClipByPath = () => {
      const params = new URLSearchParams(window.location.search);
      const clipPath = params.get('clip');
      if (!clipPath) {
        return;
      }
      const match = Array.from(clipTiles).find((tile) => tile.dataset.path === clipPath);
      if (match) {
        match.click();
        match.scrollIntoView({ block: 'center', behavior: 'smooth' });
      }
    };

    clipTiles.forEach((tile) => {
      tile.addEventListener('click', () => {
        clipTiles.forEach((item) => item.classList.remove('active'));
        tile.classList.add('active');
        if (previewPlayer) {
          previewPlayer.src = tile.dataset.src || '';
          previewPlayer.load();
        }
        if (previewTitle) {
          previewTitle.textContent = tile.dataset.timestamp || '';
        }
        if (previewOffset) {
          previewOffset.textContent = tile.dataset.offset || '';
        }
        if (previewTop) {
          const top = tile.dataset.top || '0';
          const topReason = tile.dataset.topReason || '';
          if (top === '1') {
            previewTop.classList.remove('hidden');
            previewTop.textContent = 'Top';
            previewTop.title = topReason;
          } else {
            previewTop.classList.add('hidden');
            previewTop.textContent = '';
            previewTop.title = '';
          }
        }
        if (previewBadges) {
          const kills = tile.dataset.kills || '';
          const assists = tile.dataset.assists || '';
          const deaths = tile.dataset.deaths || '';
          previewBadges.innerHTML = '';
          if (kills) {
            previewBadges.innerHTML += `<span class="chip">Kills: ${kills}</span>`;
          }
          if (assists) {
            previewBadges.innerHTML += `<span class="chip">Assists: ${assists}</span>`;
          }
          if (deaths) {
            previewBadges.innerHTML += `<span class="chip">Deaths: ${deaths}</span>`;
          }
        }
      });
    });

    openButtons.forEach((button) => {
      button.addEventListener('click', (event) => {
        event.stopPropagation();
        const url = button.dataset.openUrl || '';
        if (!url) {
          return;
        }
        fetch(url, { method: 'POST' });
      });
    });

    deleteButtons.forEach((button) => {
      button.addEventListener('click', (event) => {
        event.stopPropagation();
        const url = button.dataset.deleteUrl || '';
        if (!url) {
          return;
        }
        fetch(url, { method: 'POST' })
          .then((response) => {
            if (!response.ok) {
              return;
            }
            const rail = document.querySelector('.clip-rail');
            if (rail) {
              const scrollTop = rail.scrollTop;
              const tile = button.closest('.clip-tile');
              const wasActive = tile && tile.classList.contains('active');
              if (tile) {
                tile.remove();
              }
              rail.scrollTop = scrollTop;
              if (wasActive) {
                const nextTile = rail.querySelector('.clip-tile');
                if (nextTile) {
                  nextTile.click();
                }
              }
            }
          });
      });
    });

    iconLinks.forEach((link) => {
      link.addEventListener('click', (event) => {
        event.stopPropagation();
      });
    });

    selectClipByPath();
  </script>
</body>
</html>
